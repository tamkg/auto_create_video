{% extends "base.html" %}

{% block title %}Danh s√°ch Video{% endblock %}

{% block head_extra %}
<style>
    body {
        /* max-width: 900px; */
        margin: auto;
        /* padding: 20px; */
        background-color: #f9f9f9;
    }
    .settings-popup {
        display: none;
        position: absolute;
        top: 20px;
        right: 10px;
        background: #fff;
        border: 1px solid #ccc;
        padding: 15px;
        border-radius: 6px;
        box-shadow: 0 0 10px #aaa;
        z-index: 100;
        width: 280px;
    }
    .settings-popup.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<h1 class="mb-4">üìº Danh s√°ch Video</h1>

<!-- T√¨m ki·∫øm -->
<div class="mb-4">
    <input type="text" id="searchInput" class="form-control" placeholder="T√¨m ki·∫øm theo t√™n ho·∫∑c ID video">
</div>

<a href="{{ url_for('video.create_video') }}" class="btn btn-success mb-4">+ T·∫°o Video M·ªõi</a>

{% for video in videos %}
<div class="card mb-4 shadow-sm video-item" data-title="{{ video.title|lower }}" data-id="{{ video.id }}">
    <div class="card-body position-relative">
        <h2 class="card-title h5">{{ video.title }}</h2>
        <p><strong>ID:</strong> {{ video.id }}</p>

        <a href="{{ url_for('video.video_detail', video_id=video.id) }}" class="btn btn-primary me-2">Xem Chi Ti·∫øt</a>
        <a href="{{ url_for('video.edit_video', video_id=video.id) }}" class="btn btn-success me-2">S·ª≠a</a>

        <div class="export-section mt-3 p-3 bg-light rounded">
<form action="{{ url_for('video.export_video', video_id=video.id) }}" method="GET" class="row g-3 align-items-center">

    <!-- Ch·ªçn TTS Engine -->
    <div class="col-md-4">
        <label for="tts_type_{{ video.id }}" class="form-label">Ch·ªçn TTS:</label>
        <select name="tts_type" id="tts_type_{{ video.id }}" class="form-select tts-type-select" data-video-id="{{ video.id }}">
            <option value="google">Google TTS</option>
            <option value="edge">Edge TTS</option>
        </select>
    </div>

    <!-- Ng√¥n ng·ªØ lu√¥n hi·ªán -->
    <div class="col-md-4">
        <label for="lang_{{ video.id }}" class="form-label">Ng√¥n ng·ªØ ƒë√≠ch (D√πng ƒë·ªÉ d·ªãch):</label>
        <select name="lang" id="lang_{{ video.id }}" class="form-select">
            {% for code, name in languages.items() %}
            <option value="{{ code }}">{{ name }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- B·∫£ng ch·ªçn gi·ªçng (Edge TTS) -->
    <div class="col-12 tts-edge tts-toggle d-none" id="edge-voice-{{ video.id }}">
        <label class="form-label fw-bold">Ch·ªçn gi·ªçng ƒë·ªçc (Edge TTS):</label>

        <div class="row mb-2">
            <div class="col-md-6">
                <input type="text" name="filter_name" class="form-control filter-name-input" placeholder="L·ªçc theo t√™n (v√≠ d·ª•: vi)">
            </div>
            <div class="col-md-3">
                <select name="filter_gender" class="form-select filter-gender-select">
                    <option value="">T·∫•t c·∫£</option>
                    <option value="Female">N·ªØ</option>
                    <option value="Male">Nam</option>
                </select>
            </div>
        </div>

        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
            <table class="table table-bordered table-sm voice-table">
                <thead>
                    <tr>
                        <th>Ch·ªçn</th>
                        <th>T√™n</th>
                        <th>Gi·ªõi t√≠nh</th>
                        <th>Categories</th>
                        <th>Test</th>
                    </tr>
                </thead>
                <tbody>
                {% for voice in edge_voices %}
                <tr>
                    <td>
                        <input type="radio" name="voice" value="{{ voice.Name }}"
                            {% if loop.first %}checked{% endif %}>
                    </td>
                    <td class="voice-name">{{ voice.Name }}</td>
                    <td class="voice-gender">{{ voice.Gender }}</td>
                    <td class="content-categories">{{ voice.ContentCategories }}</td>
                        <td>
                    <button type="button" class="btn btn-sm btn-outline-secondary test-voice-btn"
                            data-voice="{{ voice.Name }}"
                            data-lang="{{ voice.Locale }}"
                            data-text="Xin ch√†o! ƒê√¢y l√† b·∫£n ki·ªÉm tra gi·ªçng n√≥i.">
                        üîä Test
                    </button>
                </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- T·ªâ l·ªá video -->
    <div class="col-md-4">
        <label for="ratio_{{ video.id }}" class="form-label">T·ªâ l·ªá video:</label>
        <select name="ratio" id="ratio_{{ video.id }}" class="form-select">
            <option value="horizontal">üé¨ 16:9 (YouTube)</option>
            <option value="vertical">üì± 9:16 (TikTok, Shorts)</option>
            <option value="square">‚¨õ 1:1 (Instagram)</option>
        </select>
    </div>

    <!-- N√∫t Export -->
    <div class="col-12">
        <button type="submit" class="btn btn-purple btn-primary">üéû Export Video</button>
    </div>
</form>
</div>



        <form action="{{ url_for('video.delete_video', video_id=video.id) }}" method="POST" style="display:inline;">
            <button type="submit" class="btn btn-danger mt-3" onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën xo√° video n√†y kh√¥ng?');">üóë Xo√°</button>
        </form>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block scripts %}
<script>
    document.querySelectorAll(".tts-type-select").forEach(select => {
        select.addEventListener("change", function () {
            const videoId = this.dataset.videoId;
            const selected = this.value;
            const edgeVoice = document.getElementById("edge-voice-" + videoId);
            edgeVoice.classList.toggle("d-none", selected !== "edge");
        });
    });

    // L·ªçc b·∫£ng gi·ªçng ƒë·ªçc
    document.querySelectorAll(".tts-edge").forEach(section => {
        const filterName = section.querySelector(".filter-name-input");
        const filterGender = section.querySelector(".filter-gender-select");
        const rows = section.querySelectorAll("tbody tr");

        function applyFilter() {
            const nameVal = filterName.value.toLowerCase();
            const genderVal = filterGender.value;

            rows.forEach(row => {
                const voiceName = row.querySelector(".voice-name").textContent.toLowerCase();
                const voiceGender = row.querySelector(".voice-gender").textContent;
                const match = voiceName.includes(nameVal) && (genderVal === "" || voiceGender === genderVal);
                row.style.display = match ? "" : "none";
            });
        }

        filterName?.addEventListener("input", applyFilter);
        filterGender?.addEventListener("change", applyFilter);
    });
</script>

<script>
document.querySelectorAll('.test-voice-btn').forEach(button => {
    button.addEventListener('click', function () {
        const voice = this.dataset.voice;
        const lang = this.dataset.lang;
        const text = this.dataset.text;

        this.disabled = true;
        this.dataset.originalText = this.innerText;
        this.innerHTML = `<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> ƒêang ph√°t...`;


        fetch(`/create_video/api/test-voice`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: new URLSearchParams({
                voice: voice,
                lang: lang,
                text: text,
                engine: voice ? 'edge' : 'google'  // T·ª± ƒë·ªông ch·ªçn engine theo voice
            })
        })
        .then(res => {
            if (!res.ok) throw new Error("T·∫£i kh√¥ng th√†nh c√¥ng");
            return res.blob();
        })
        .then(blob => {
            const url = URL.createObjectURL(blob);
            const audio = new Audio(url);
            audio.play();
            audio.onended = () => {
                this.disabled = false;
                this.innerHTML = this.dataset.originalText || "üîä Test";
            };
        })
        .catch(err => {
            alert("L·ªói khi test gi·ªçng: " + err.message);
            this.disabled = false;
            this.innerHTML = this.dataset.originalText || "üîä Test";
        });
    });
});

// L·∫Øng nghe s·ª± ki·ªán input c·ªßa √¥ t√¨m ki·∫øm
document.getElementById('searchInput').addEventListener('input', function () {
    const searchTerm = this.value.toLowerCase(); // Chuy·ªÉn ch·ªØ th∆∞·ªùng ƒë·ªÉ so s√°nh kh√¥ng ph√¢n bi·ªát hoa th∆∞·ªùng
    const videoItems = document.querySelectorAll('.video-item'); // L·∫•y t·∫•t c·∫£ c√°c video item
    
    videoItems.forEach(item => {
        const title = item.getAttribute('data-title'); // L·∫•y ti√™u ƒë·ªÅ video
        const id = item.getAttribute('data-id'); // L·∫•y ID video

        // Ki·ªÉm tra n·∫øu ti√™u ƒë·ªÅ ho·∫∑c ID ch·ª©a t·ª´ kh√≥a t√¨m ki·∫øm
        if (title.includes(searchTerm) || id.includes(searchTerm)) {
            item.style.display = ''; // Hi·ªÉn th·ªã video n·∫øu t√¨m th·∫•y
        } else {
            item.style.display = 'none'; // ·∫®n video n·∫øu kh√¥ng t√¨m th·∫•y
        }
    });
});
</script>

{% endblock %}