<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Quản lý URL</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        /* Spinner nhỏ bên trong button */
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
            border-width: 0.15em;
            vertical-align: text-bottom;
            margin-left: 0.5rem;
        }
        .playlist-videos {
            max-height: 180px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 0.5rem;
            background-color: #f8f9fa;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        .playlist-videos li {
            margin-bottom: 0.25rem;
            word-break: break-word;
        }
    </style>
</head>
<body>

    {% with messages = get_flashed_messages() %}
    {% if messages %}
        <div class="container mt-3">
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                {% for message in messages %}
                    <p class="mb-0">{{ message }}</p>
                {% endfor %}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    {% endif %}
    {% endwith %}

    <div class="container mt-4">
        <h2 class="mb-4">Quản lý URL</h2>

        <!-- Form thêm URL -->
        <form id="urlForm" action="/url/add" method="post" class="mb-4">
            <div class="input-group mb-2">
                <input
                    type="text"
                    id="urlInput"
                    name="url"
                    class="form-control"
                    placeholder="Nhập URL mới"
                    required
                    autocomplete="off"
                />
                <button type="button" id="fetchTitleBtn" class="btn btn-secondary">
                    Lấy tiêu đề
                    <span id="titleSpinner" class="spinner-border spinner-border-sm visually-hidden" role="status" aria-hidden="true"></span>
                </button>
            </div>

            <!-- Checkbox lấy playlist -->
            <div class="form-check mb-2" id="playlistOption" style="display:none;">
<input
    class="form-check-input"
    type="checkbox"
    id="fetchPlaylistCheckbox"
    name="fetch_playlist"
    value="on"
/>
                <label class="form-check-label" for="fetchPlaylistCheckbox">
                    Lấy toàn bộ video trong playlist
                </label>
            </div>

            <!-- Hiển thị danh sách video playlist khi checked -->
            <div id="playlistVideosContainer" class="playlist-videos visually-hidden">
                <strong>Danh sách video trong playlist:</strong>
                <ul id="playlistVideosList" class="mb-0"></ul>
            </div>

            <input
                type="text"
                id="titleInput"
                name="title"
                class="form-control mb-3"
                placeholder="Tiêu đề video (tự động hoặc nhập tay)"
                autocomplete="off"
            />

            <div class="mb-3">
                <label for="categoryInput" class="form-label">Chọn Category:</label>
                <select id="categoryInput" name="category" class="form-select">
                    <option value="None" selected>None</option>
                    <option value="YouTube">YouTube</option>
                    <option value="TikTok">TikTok</option>
                    <option value="Facebook">Facebook</option>
                    <option value="Twitter">Twitter</option>
                    <option value="Instagram">Instagram</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <button type="submit" class="btn btn-primary">Thêm URL</button>
        </form>

        <!-- Bảng danh sách URL -->
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>URL</th>
                        <th>Title</th>
                        <th>Category</th>
                        <th>Trạng thái</th>
                        <th>Tỉ lệ</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    {% for url in urls %}
                    <tr>
                        <td>{{ url.id }}</td>
                        <td>
                            <a href="{{ url.url }}" target="_blank" rel="noopener noreferrer" class="text-break">
                                {{ url.url }}
                            </a>
                        </td>
                        <td>{{ url.title or '' }}</td>
                        <td>{{ url.category or 'None' }}</td>
                        <td>{{ url.status or 'Chưa xác định' }}</td>
                        <td>{{ url.ratio or 'Chưa xác định' }}</td>
                        <td>
                            <button
                                class="btn btn-warning btn-sm me-1"
                                onclick="editUrl({{ url.id }}, {{ url.url|tojson }}, {{ (url.title or '')|tojson }}, {{ (url.category or 'None')|tojson }})"
                                type="button"
                                aria-label="Sửa URL {{ url.id }}"
                            >
                                Sửa
                            </button>
                            <button
                                class="btn btn-danger btn-sm"
                                onclick="deleteUrl({{ url.id }})"
                                type="button"
                                aria-label="Xóa URL {{ url.id }}"
                            >
                                Xóa
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal chỉnh sửa URL -->
    <div
        class="modal fade"
        id="editUrlModal"
        tabindex="-1"
        aria-labelledby="editUrlModalLabel"
        aria-hidden="true"
    >
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editUrlForm" onsubmit="event.preventDefault(); saveEditUrl();">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editUrlModalLabel">Chỉnh sửa URL</h5>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Đóng"
                        ></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editUrlId" />

                        <div class="mb-3">
                            <label for="editUrlInput" class="form-label">URL</label>
                            <input
                                type="text"
                                class="form-control"
                                id="editUrlInput"
                                required
                                autocomplete="off"
                            />
                        </div>

                        <div class="mb-3">
                            <label for="editTitleInput" class="form-label">Tiêu đề</label>
                            <input
                                type="text"
                                class="form-control"
                                id="editTitleInput"
                                autocomplete="off"
                            />
                        </div>

                        <div class="mb-3">
                            <label for="editCategoryInput" class="form-label">Category</label>
                            <select id="editCategoryInput" class="form-select">
                                <option value="None">None</option>
                                <option value="YouTube">YouTube</option>
                                <option value="TikTok">TikTok</option>
                                <option value="Facebook">Facebook</option>
                                <option value="Twitter">Twitter</option>
                                <option value="Instagram">Instagram</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                        >
                            Hủy
                        </button>
                        <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const urlInput = document.getElementById("urlInput");
            const playlistOption = document.getElementById("playlistOption");
            const fetchPlaylistCheckbox = document.getElementById("fetchPlaylistCheckbox");
            const titleInput = document.getElementById("titleInput");
            const playlistVideosContainer = document.getElementById("playlistVideosContainer");
            const playlistVideosList = document.getElementById("playlistVideosList");
            const fetchTitleBtn = document.getElementById("fetchTitleBtn");
            const titleSpinner = document.getElementById("titleSpinner");
            const urlForm = document.getElementById("urlForm");

            // Hiển thị/ẩn checkbox lấy playlist, reset title khi hiển thị
            urlInput.addEventListener("input", () => {
                const val = urlInput.value.toLowerCase();
                if (val.includes("playlist")) {
                    playlistOption.style.display = "block";
                } else {
                    playlistOption.style.display = "none";
                    fetchPlaylistCheckbox.checked = false;
                    playlistVideosContainer.classList.add("visually-hidden");
                    playlistVideosList.innerHTML = "";
                }
            });

            // Khi checkbox playlist thay đổi: reset title, nếu checked thì fetch danh sách playlist
fetchPlaylistCheckbox.addEventListener("change", () => {
    titleInput.value = "";  // reset title input vì playlist không có tiêu đề đơn

    if (fetchPlaylistCheckbox.checked) {
        const url = urlInput.value.trim();
        if (!url) return;

        playlistVideosList.innerHTML = '<li><em>Đang tải danh sách video...</em></li>';
        playlistVideosContainer.classList.remove("visually-hidden");

        fetch("/url/fetch_playlist_videos", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ url }),
        })
            .then((res) => res.json())
            .then((data) => {
                playlistVideosList.innerHTML = "";
                if (data.success && Array.isArray(data.videos) && data.videos.length > 0) {
                    data.videos.forEach(video => {
                        const li = document.createElement("li");
                        const a = document.createElement("a");
                        a.href = video.url || "#";
                        a.target = "_blank";
                        a.rel = "noopener noreferrer";
                        a.textContent = video.title || video.url || "(Không có tiêu đề)";
                        li.appendChild(a);
                        playlistVideosList.appendChild(li);
                    });
                } else {
                    playlistVideosList.innerHTML = "<li><em>Không tìm thấy video trong playlist hoặc lỗi server.</em></li>";
                }
            })
            .catch(() => {
                playlistVideosList.innerHTML = "<li><em>Lỗi khi lấy danh sách video playlist.</em></li>";
            });
    } else {
        playlistVideosContainer.classList.add("visually-hidden");
        playlistVideosList.innerHTML = "";
    }
});

            // Xử lý lấy tiêu đề video
            fetchTitleBtn.addEventListener("click", () => {
                const url = urlInput.value.trim();
                if (!url) {
                    alert("❌ Vui lòng nhập URL trước khi lấy tiêu đề.");
                    return;
                }
                // Nếu đang lấy playlist, không fetch tiêu đề đơn lẻ
                if (fetchPlaylistCheckbox.checked) {
                    alert("❌ Đang chọn lấy toàn bộ playlist, không thể lấy tiêu đề đơn lẻ.");
                    return;
                }

                fetchTitleBtn.disabled = true;
                titleSpinner.classList.remove("visually-hidden");

fetch("/url/fetch_title", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ url }),
})
.then((res) => res.json())
.then((data) => {
    if (data.success) {
        if (data.data && data.data.is_playlist) {
            // Nếu là playlist, show playlist title, hiển thị danh sách URL
            titleInput.value = data.data.playlist_title || "";
            playlistVideosList.innerHTML = "";
            data.data.playlist_urls.forEach(videoUrl => {
                const li = document.createElement("li");
                const a = document.createElement("a");
                a.href = videoUrl;
                a.target = "_blank";
                a.rel = "noopener noreferrer";
                a.textContent = videoUrl;
                li.appendChild(a);
                playlistVideosList.appendChild(li);
            });
            playlistVideosContainer.classList.remove("visually-hidden");
            playlistOption.style.display = "block";
            fetchPlaylistCheckbox.checked = true;
        } else if (data.data && data.data.title) {
            // Nếu không phải playlist mà có title đơn
            titleInput.value = data.data.title;
            playlistVideosContainer.classList.add("visually-hidden");
            playlistVideosList.innerHTML = "";
            playlistOption.style.display = "none";
            fetchPlaylistCheckbox.checked = false;
        } else {
            alert("❌ Không lấy được tiêu đề. Vui lòng kiểm tra lại URL.");
        }
    } else {
        alert("❌ " + (data.message || "Lỗi khi lấy tiêu đề."));
    }
})
.catch(() => alert("❌ Có lỗi khi lấy tiêu đề."))
.finally(() => {
    fetchTitleBtn.disabled = false;
    titleSpinner.classList.add("visually-hidden");
});

                });
        // Xử lý submit form thêm URL
        urlForm.addEventListener("submit", (event) => {
            // Nếu checkbox fetch_playlist ẩn thì bỏ trường fetch_playlist để backend không nhầm lẫn
if (playlistOption.style.display === "none") {
    fetchPlaylistCheckbox.checked = false;
} else {
    fetchPlaylistCheckbox.checked = true;
}

        });
    });

    // Modal và AJAX sửa URL
    const editUrlModal = new bootstrap.Modal(document.getElementById("editUrlModal"));
    function editUrl(id, url, title, category) {
        document.getElementById("editUrlId").value = id;
        document.getElementById("editUrlInput").value = url;
        document.getElementById("editTitleInput").value = title;
        document.getElementById("editCategoryInput").value = category || "None";
        editUrlModal.show();
    }

    function saveEditUrl() {
        const id = document.getElementById("editUrlId").value;
        const url = document.getElementById("editUrlInput").value.trim();
        const title = document.getElementById("editTitleInput").value.trim();
        const category = document.getElementById("editCategoryInput").value;

        if (!url) {
            alert("❌ URL không được để trống.");
            return;
        }

        fetch("/url/edit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id, url, title, category }),
        })
            .then((res) => res.json())
            .then((data) => {
                if (data.success) {
                    location.reload();
                } else {
                    alert("❌ " + (data.message || "Lỗi khi lưu thay đổi."));
                }
            })
            .catch(() => alert("❌ Có lỗi khi gửi yêu cầu."));
    }

    // Xóa URL
    function deleteUrl(id) {
        if (confirm("Bạn có chắc muốn xóa URL này?")) {
            fetch("/url/delete", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id }),
            })
                .then((res) => res.json())
                .then((data) => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert("❌ " + (data.message || "Lỗi khi xóa URL."));
                    }
                })
                .catch(() => alert("❌ Có lỗi khi gửi yêu cầu."));
        }
    }
</script>
</body> </html>