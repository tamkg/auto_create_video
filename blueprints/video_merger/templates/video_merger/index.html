{% extends "base.html" %}
{% block title %}Gá»™p Video Tá»± Äá»™ng{% endblock %}

{% block content %}
<h2 class="mb-4 text-center">ğŸ§© Gá»™p Video Tá»± Äá»™ng</h2>

<!-- ğŸ”— Link chuyá»ƒn qua trang quáº£n lÃ½ video -->
<div class="text-end mb-3">
    <a href="{{ url_for('video_merger.manage_videos') }}" class="btn btn-outline-secondary">
        âš™ï¸ Quáº£n lÃ½ video clip
    </a>
</div>

<form method="POST">
    <div class="mb-3">
        <label for="category_id" class="form-label">Chá»n danh má»¥c video:</label>
        <select class="form-select" id="category_id" name="category_id" required>
            {% for cat in categories %}
                <option value="{{ cat.id }}">{{ cat.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-3">
        <label for="ratio" class="form-label">Chá»n tá»· lá»‡ khung hÃ¬nh:</label>
        <select class="form-select" id="ratio" name="ratio" required>
            <option value="16:9">16:9 (ngang)</option>
            <option value="9:16">9:16 (dá»c)</option>
        </select>
    </div>

    <div class="mb-3">
        <label for="duration" class="form-label">Thá»i lÆ°á»£ng mong muá»‘n (giÃ¢y):</label>
        <input type="number" class="form-control" id="duration" name="duration" placeholder="VÃ­ dá»¥: 600" required>
    </div>

    <button type="submit" class="btn btn-primary">Gá»™p video</button>
</form>
{% if videos %}
  <hr>
  <h4>Káº¿t quáº£ tá»« danh má»¥c <code>{{ selected_category.name }}</code>:</h4>

  <div class="border rounded p-3 mb-3" style="max-height: 300px; overflow-y: auto;">
    <ul class="list-group list-group-flush">
      {% for video in videos %}
        <li class="list-group-item">
          {{ video.filename }} â€”
          {% if video.cut_to is defined %}
            <strong>{{ video.cut_to }}s</strong>
            <span class="badge bg-info text-dark">âœ‚ï¸ Cáº¯t tá»« {{ video.duration | round(1) }}s</span>
          {% else %}
            {{ video.duration | round(1) }}s
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  </div>

<form method="POST" action="{{ url_for('video_merger.generate_video') }}">
  <div class="row">
    <div class="col-md-6 mb-3">
      <label for="output_name" class="form-label">ğŸ“ TÃªn file xuáº¥t:</label>
      <input type="text" class="form-control" name="output_name" id="output_name" placeholder="merged_output.mp4">
    </div>

    <div class="col-md-6 mb-3">
      <label for="fps" class="form-label">ğŸï¸ FPS:</label>
      <select class="form-select" name="fps" id="fps" required>
        <option value="24">24 FPS</option>
        <option value="30" selected>30 FPS</option>
        <option value="60">60 FPS</option>
      </select>
    </div>

    <div class="col-md-6 mb-3">
      <label for="resolution" class="form-label">ğŸ–¥ï¸ Äá»™ phÃ¢n giáº£i:</label>
      <select class="form-select" name="resolution" id="resolution">
        <option value="keep" selected>ğŸ“ Giá»¯ nguyÃªn (khÃ´ng scale)</option>
        <option value="1920x1080">1920x1080 (16:9)</option>
        <option value="1080x1920">1080x1920 (9:16)</option>
        <option value="1080x1080">1080x1080 (1:1)</option>
      </select>
    </div>

    <div class="col-md-6 mb-3">
      <label for="aspect_ratio" class="form-label">ğŸ“ Tá»‰ lá»‡ khung hÃ¬nh (náº¿u khÃ´ng chá»n Ä‘á»™ phÃ¢n giáº£i):</label>
      <select class="form-select" name="aspect_ratio" id="aspect_ratio">
        <option value="keep" selected>ğŸ“ Giá»¯ nguyÃªn (khÃ´ng scale)</option>
        <option value="16:9">16:9</option>
        <option value="9:16">9:16</option>
        <option value="1:1">1:1</option>
      </select>
    </div>

    <div class="col-md-6 mb-3">
      <label for="codec" class="form-label">ğŸ¥ Codec:</label>
      <select class="form-select" name="codec" id="codec" required>
        <option value="libx264" selected>libx264 (phá»• biáº¿n)</option>
        <option value="h264_qsv">h264_qsv (Intel GPU)</option>
        <option value="hevc_qsv">hevc_qsv (Intel GPU)</option>
      </select>
    </div>

    <div class="col-md-6 mb-3">
      <label for="preset" class="form-label">âš™ï¸ Preset:</label>
      <select class="form-select" name="preset" id="preset" required>
        <option value="ultrafast">ultrafast</option>
        <option value="superfast">superfast</option>
        <option value="fast" selected>fast</option>
        <option value="medium">medium</option>
        <option value="slow">slow</option>
      </select>
    </div>
  </div>

  {% for video in selected_videos %}
    <input type="hidden" name="video_ids" value="{{ video.id }}">
    {% if video.cut_to is defined %}
      <input type="hidden" name="cut_to_{{ video.id }}" value="{{ video.cut_to }}">
    {% endif %}
  {% endfor %}

  <div class="col-md-6 mb-3">
    <label for="keep_audio" class="form-label">ğŸ”Š Ã‚m thanh gá»‘c:</label>
    <select class="form-select" name="keep_audio" id="keep_audio" required>
      <option value="yes" selected>Giá»¯ nguyÃªn Ã¢m thanh</option>
      <option value="no">Táº¯t tiáº¿ng</option>
    </select>
  </div>

  <div class="text-center">
    <button type="submit" class="btn btn-success">
      ğŸš€ Táº¡o video tá»•ng há»£p
    </button>
  </div>
</form>

<!-- Script Ä‘á»ƒ áº©n/hiá»‡n aspect_ratio tÃ¹y theo resolution -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const resolutionSelect = document.getElementById("resolution");
    const aspectRatioField = document.getElementById("aspect_ratio");
    const aspectRatioWrapper = aspectRatioField.closest(".col-md-6");

    function toggleAspectRatio() {
      if (resolutionSelect.value === "keep") {
        aspectRatioWrapper.style.display = "block";
      } else {
        aspectRatioWrapper.style.display = "none";
      }
    }

    resolutionSelect.addEventListener("change", toggleAspectRatio);
    toggleAspectRatio(); // Gá»i ban Ä‘áº§u
  });
</script>
{% endif %}
{% endblock %}
