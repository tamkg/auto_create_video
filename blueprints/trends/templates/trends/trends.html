{% extends "base.html" %}

{% block title %}üìä Google Trends Viewer{% endblock %}

{% block content %}
<div class="container py-4" style="max-width: 600px;">
    <h1 class="text-center mb-4">üìä Google Trends Viewer</h1>

    <div id="flash-messages" class="alert alert-danger d-none" role="alert"></div>

    <form id="trend-form" class="mb-4">
        <div class="mb-3">
            <label for="keywords" class="form-label">Nh·∫≠p t·ª´ kh√≥a (c√°ch nhau b·ªüi d·∫•u ph·∫©y):</label>
            <input type="text" name="keywords" id="keywords" class="form-control" placeholder="V√≠ d·ª•: python, ai, blockchain" required />
        </div>

        <div class="mb-3">
            <label for="timeframe" class="form-label">Ch·ªçn khung th·ªùi gian:</label>
            <select name="timeframe" id="timeframe" class="form-select">
                <option value="today 12-m">12 th√°ng qua</option>
                <option value="today 3-m">3 th√°ng qua</option>
                <option value="today 1-m">1 th√°ng qua</option>
                <option value="today 7-d">7 ng√†y qua</option>
                <option value="now 1-d">24 gi·ªù qua</option>
            </select>
        </div>

        <button type="submit" class="btn btn-success w-100">üìä Xem Xu H∆∞·ªõng</button>
    </form>

    <div id="loading" class="text-center mb-3" style="display:none;">
        <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
        <div>ƒêang t·∫£i bi·ªÉu ƒë·ªì xu h∆∞·ªõng...</div>
    </div>

    <div id="trend-results" class="d-none">
        <h2>K·∫øt qu·∫£ xu h∆∞·ªõng:</h2>
        <img id="trend-chart" src="" alt="K·∫øt qu·∫£ bi·ªÉu ƒë·ªì xu h∆∞·ªõng" class="img-fluid rounded mt-3" />
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const form = document.getElementById('trend-form');
    const flashMessages = document.getElementById('flash-messages');
    const trendChart = document.getElementById('trend-chart');
    const loading = document.getElementById('loading');
    const trendResults = document.getElementById('trend-results');

    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        const formData = new FormData(this);

        flashMessages.classList.add('d-none');
        flashMessages.textContent = '';
        trendChart.style.display = 'none';
        trendResults.classList.add('d-none');
        loading.style.display = 'block';

        try {
            const response = await fetch('/trends/trends', {
                method: 'POST',
                body: formData
            });

            loading.style.display = 'none';

            if (response.headers.get("Content-Type")?.includes("image/png")) {
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                trendChart.src = url;
                trendChart.style.display = 'block';
                trendResults.classList.remove('d-none');
            } else {
                const result = await response.json();
                flashMessages.textContent = result.message || "Kh√¥ng t√¨m th·∫•y xu h∆∞·ªõng cho t·ª´ kh√≥a n√†y.";
                flashMessages.classList.remove('d-none');
            }
        } catch (error) {
            loading.style.display = 'none';
            flashMessages.textContent = "ƒê√£ x·∫£y ra l·ªói khi t·∫£i bi·ªÉu ƒë·ªì. Vui l√≤ng th·ª≠ l·∫°i.";
            flashMessages.classList.remove('d-none');
        }
    });
</script>
{% endblock %}
